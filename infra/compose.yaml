name: pcaa
services:
    # 1. KONTENER SIECIOWY (Sidecar & tailscale)
    sidecar:
        container_name: pcaa-sidecar
        image: tailscale/tailscale:latest
        hostname: dev-app-instance
        devices:
            - /dev/net/tun:/dev/net/tun
        env_file:
            - ../.env
        environment:
            - TS_EXTRA_ARGS=--advertise-tags=tag:dev
            - TS_STATE_DIR=/var/lib/tailscale
            - TS_USERSPACE=false
        cap_add:
            - NET_ADMIN
            - NET_RAW
        volumes:
            - tailscale-data:/var/lib/tailscale
        restart: unless-stopped
        ports:
            - "8080:80"

    # 2. BACKEND (FastAPI)
    api:
        container_name: pcaa-api
        build:
            context: ..
            dockerfile: infra/api/Dockerfile
        env_file:
            - ../.env
        volumes:
            - ../backend:/workroot
        network_mode: service:sidecar
        depends_on:
            - sidecar

    # 3. FRONTEND (Next.js)
    frontend:
        container_name: pcaa-frontend
        build:
            context: ../frontend
            dockerfile: Dockerfile
        volumes:
            - ../frontend:/app
            - /app/node_modules
            - /app/.next
        network_mode: service:sidecar
        depends_on:
            - api

    # 4. PROXY (Nginx)
    nginx:
        container_name: pcaa-nginx
        image: nginx:mainline-alpine
        network_mode: service:sidecar
        volumes:
            - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
        depends_on:
            - api
            - frontend

volumes:
  tailscale-data:
